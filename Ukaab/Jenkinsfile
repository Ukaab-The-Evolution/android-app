pipeline {
  agent any
  parameters {
    string(name: 'BUILD_TYPE', defaultValue: 'Release', description: 'Build type: Debug or Release')
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build via Docker') {
      steps {
        script {
          def userId = sh(script: "id -u || echo 1000", returnStdout: true).trim()
          docker.build("android-build:${env.BUILD_TYPE}", "--build-arg LOCAL_USER_ID=${userId} .")
            .inside("-e LOCAL_USER_ID=${userId}") {
              if (params.BUILD_TYPE == "Release") {
                sh "cd android && ./gradlew assembleRelease"
              } else {
                sh "cd android && ./gradlew assembleDebug"
              }
            }
        }
      }
    }

    stage('Archive APK') {
      steps {
        archiveArtifacts artifacts: 'android/app/build/outputs/apk/**/*.apk', fingerprint: true
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
